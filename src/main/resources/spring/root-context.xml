<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ This file is part of Dependency-Track.
  ~
  ~ Dependency-Track is free software: you can redistribute it and/or modify it
  ~ under the terms of the GNU General Public License as published by the Free
  ~ Software Foundation, either version 3 of the License, or (at your option) any
  ~ later version.
  ~
  ~ Dependency-Track is distributed in the hope that it will be useful, but
  ~ WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  ~ FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
  ~ details.
  ~
  ~ You should have received a copy of the GNU General Public License along with
  ~ Dependency-Track. If not, see http://www.gnu.org/licenses/.
  ~
  ~ Copyright (c) Axway. All Rights Reserved.
  -->

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:p="http://www.springframework.org/schema/p"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd

       	      http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd">

    <import resource="classpath:spring/properties.xml"/>

    <!-- Root Context: defines shared resources visible to all other web components -->
    <bean id="shiroFilter" class="org.apache.shiro.spring.web.ShiroFilterFactoryBean">
        <property name="securityManager" ref="securityManager"/>
        <property name="loginUrl" value="/login"/>
        <property name="successUrl" value="/dashboard"/>
        <property name="filterChainDefinitionMap">
            <map>
                <!-- Add mapping to all the urls in Dependency Track -->
                <entry key="/resources/**" value="anon"/>
                <entry key="/registerUser" value="anon"/>
                <entry key="/login" value="anon"/>
                <entry key="/logout" value="user"/>
                <entry key="/applications" value="user"/>
                <entry key="/applicationVersion" value="user"/>
                <entry key="/libraries" value="user"/>
                <entry key="/vulnerabilities" value="user"/>
                <entry key="/libraryHierarchy" value="anon"/>
                <entry key="/searchApplication" value="user"/>
                <entry key="/dashboard" value="user"/>
                <entry key="/error" value="user"/>
                <entry key="/about" value="user"/>
                <entry key="/dcdata" value="anon"/>
                <entry key="/nist/**" value="anon"/>
                <entry key="/**" value="user"/>
            </map>
        </property>
    </bean>

    <bean id="dataSource" class="org.apache.commons.dbcp.BasicDataSource"
          destroy-method="close" p:driverClassName="${jdbc.driverClassName}"
          p:url="${jdbc.url}" p:username="${jdbc.username}" p:password="${jdbc.password}"/>

    <bean id="sessionFactory" class="org.springframework.orm.hibernate4.LocalSessionFactoryBean">
        <property name="dataSource" ref="dataSource"/>
        <property name="packagesToScan" value="org.owasp.dependencytrack.model"/>
        <property name="hibernateProperties">
            <props>
                <prop key="hibernate.dialect">${hibernate.dialect}</prop>
                <prop key="hibernate.show_sql">${hibernate.show_sql}</prop>
                <prop key="hibernate.hbm2ddl.auto">${hibernate.hbm2ddl.auto}</prop>
            </props>
        </property>
    </bean>

    <bean id="lifecycleBeanPostProcessor" class="org.apache.shiro.spring.LifecycleBeanPostProcessor"/>
    <bean id="securityManager" class="org.apache.shiro.web.mgt.DefaultWebSecurityManager">
        <property name="realms">
            <list>
                <ref bean="jdbcRealm"/>
                <!--
                <ref local="ldapRealm"/>
                -->
            </list>
        </property>
        <property name="authenticator.authenticationStrategy">
            <bean class="org.apache.shiro.authc.pam.FirstSuccessfulStrategy"/>
        </property>
        <property name="cacheManager" ref="cacheManager"/>
    </bean>

    <bean id="cacheManager" class="org.apache.shiro.cache.ehcache.EhCacheManager">
        <property name="cacheManager" ref="ehCacheManager"/>
    </bean>

    <bean id="ehCacheManager" class="org.springframework.cache.ehcache.EhCacheManagerFactoryBean"/>

    <bean class="org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"
          depends-on="lifecycleBeanPostProcessor"/>
    <bean class="org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor">
        <property name="securityManager" ref="securityManager"/>
    </bean>

    <tx:annotation-driven transaction-manager="transactionManager" mode='proxy' proxy-target-class='true' />

    <bean id="transactionManager" class="org.springframework.orm.hibernate4.HibernateTransactionManager">
        <property name="sessionFactory" ref="sessionFactory"/>
    </bean>

    <!--
    <bean id="ldapRealm" class="org.owasp.dependencytrack.auth.ActiveDirectoryAuthenticationRealm">
        <property name="url" value="ldap://hostname:389"/>
        <property name="principalSuffix" value="@example.com"/>
    </bean>
    -->

    <bean id="credentialsMatcher" class="org.owasp.dependencytrack.auth.BcryptCredentialsMatcher"/>
    <bean id="jdbcRealm" class="org.owasp.dependencytrack.auth.JdbcConfigurableDefaultRoleRealm">
        <property name="credentialsMatcher" ref="credentialsMatcher"/>
        <property name="dataSource" ref="dataSource"/>
        <property name="saltStyle" value="NO_SALT"/>
        <property name="authenticationQuery"
                  value="select password from users where username = ? and isldap = false"/>
        <property name="userRolesQuery"
                  value="SELECT role FROM roles r, users u WHERE u.username=? and r.ID=u.roleid"/>
        <property name="permissionsQuery"
                  value="SELECT p.permissionname FROM roles r, permissions p, roles_permissions rp
                         WHERE r.id=rp.roles_id AND p.id=rp.permissions_id AND r.role=?"/>
        <property name="permissionsLookupEnabled" value="true"/>
    </bean>

</beans>
