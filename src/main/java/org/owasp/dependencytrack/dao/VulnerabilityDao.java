/*
 * This file is part of Dependency-Track.
 *
 * Dependency-Track is free software: you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation, either version 3 of the License, or (at your option) any
 * later version.
 *
 * Dependency-Track is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 *
 * You should have received a copy of the GNU General Public License along with
 * Dependency-Track. If not, see http://www.gnu.org/licenses/.
 *
 * Copyright (c) Axway. All Rights Reserved.
 */

package org.owasp.dependencytrack.dao;

import org.hibernate.Criteria;
import org.hibernate.Query;
import org.hibernate.SessionFactory;
import org.hibernate.criterion.Expression;
import org.hibernate.criterion.ProjectionList;
import org.hibernate.criterion.Projections;
import org.owasp.dependencytrack.model.Application;
import org.owasp.dependencytrack.model.ApplicationDependency;
import org.owasp.dependencytrack.model.ApplicationVersion;
import org.owasp.dependencytrack.model.LibraryVersion;
import org.owasp.dependencytrack.model.ScanResult;
import org.owasp.dependencytrack.model.Vulnerability;
import org.owasp.dependencytrack.model.VulnerabilitySummary;
import org.owasp.dependencytrack.model.VulnerableComponent;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Repository;

import java.util.ArrayList;
import java.util.List;

@Repository
public class VulnerabilityDao {

    /**
     * Setup logger
     */
    private static final Logger LOGGER = LoggerFactory.getLogger(VulnerabilityDao.class);

    /**
     * The Hibernate SessionFactory
     */
    @Autowired
    private SessionFactory sessionFactory;

    /**
     * Returns a list of Vulnerability objects for LibraryVersions
     * that have a dependency of the specified ApplicationVersion.
     *
     * @param applicationVersion The ApplicationVersion to retrieve vulnerability for
     * @return a List of Vulnerability objects
     */
    @SuppressWarnings("unchecked")
    public List<VulnerableComponent> getVulnerableComponents(ApplicationVersion applicationVersion) {
        final Query query = sessionFactory.getCurrentSession().
                createQuery("from ApplicationDependency where applicationVersion=:version");
        query.setParameter("version", applicationVersion);

        final List<VulnerableComponent> vulnerableComponents = new ArrayList<>();

        // Retrieve all of the library versions from the specified application version
        final List<LibraryVersion> libvers = new ArrayList<>();
        final List<ApplicationDependency> deps = query.list();
        for (ApplicationDependency dep : deps) {
            libvers.add(dep.getLibraryVersion());
        }

        // Iterate through the library versions looking for scan results
        for (LibraryVersion libraryVersion: libvers) {
            Criteria criteria = sessionFactory.getCurrentSession().createCriteria(ScanResult.class);
            criteria.add(Expression.eq("libraryVersion", libraryVersion));
            ProjectionList projList = Projections.projectionList();
            projList.add(Projections.property("libraryVersion"));
            projList.add(Projections.property("vulnerability"));
            criteria.setProjection(Projections.distinct(projList));
            final List<Object[]> results = criteria.list();
            final List<Vulnerability> vulns = new ArrayList<>();

            for (Object[] result : results) {
                for (Object object : result) {
                    if (object instanceof Vulnerability) {
                        vulns.add((Vulnerability) object);
                    }
                }
            }

            final VulnerableComponent vulnerableComponent = new VulnerableComponent();
            vulnerableComponent.setLibraryVersion(libraryVersion);
            vulnerableComponent.setVulnerabilities(vulns);
            // Add the VulnerableComponent to the list of vulnerableComponents to return
            vulnerableComponents.add(vulnerableComponent);
        }
        return vulnerableComponents;
    }

    public List<VulnerabilitySummary> getVulnerabilitySummary(int id) {
        List<VulnerabilitySummary> summaryList = new ArrayList<>();
        final Query query = sessionFactory.getCurrentSession().createQuery("from Application where id=:id");
        query.setParameter("id", id);
        List<Application> applications = query.list();
        for (Application application: applications) {
            for (ApplicationVersion version: application.getVersions()) {
                summaryList.add(getVulnerabilitySummary(version));
            }
        }
        return summaryList;
    }

    public VulnerabilitySummary getVulnerabilitySummary(ApplicationVersion applicationVerion) {
        List<VulnerableComponent> vulnerableComponents = getVulnerableComponents(applicationVerion);

        VulnerabilitySummary vulnerabilitySummary = new VulnerabilitySummary();
        vulnerabilitySummary.setApplicationVersion(applicationVerion);
        vulnerabilitySummary.setVulnerableComponents(vulnerableComponents.size());

        for (VulnerableComponent vulnerableComponent: vulnerableComponents) {
            List<Vulnerability> vulnerabilities = vulnerableComponent.getVulnerabilities();

            for (Vulnerability vulnerability: vulnerabilities) {

                if (vulnerability.getSeverity() == Vulnerability.Severity.HIGH) {
                    vulnerabilitySummary.setHigh(vulnerabilitySummary.getHigh() + 1);
                } else if (vulnerability.getSeverity() == Vulnerability.Severity.MEDIUM) {
                    vulnerabilitySummary.setMedium(vulnerabilitySummary.getMedium() + 1);
                } else if (vulnerability.getSeverity() == Vulnerability.Severity.LOW) {
                    vulnerabilitySummary.setLow(vulnerabilitySummary.getLow() + 1);
                }

            }
        }
        return vulnerabilitySummary;
    }
}
